# Worktree Strategy Improvements

## Current State
- Worktrees created on detached HEAD at current commit
- No automatic way to merge changes back
- Binary choice: keep worktree or delete it

## Proposed Enhancements

### 1. Branch-Based Worktrees
```typescript
interface WorktreeOptions {
  // Branch management
  createBranch?: boolean;        // Create task-specific branch
  branchName?: string;           // Custom branch name
  baseBranch?: string;           // Branch to base work on
  
  // Merge strategies
  mergeStrategy?: 'auto' | 'pr' | 'manual' | 'patch' | 'none';
  
  // Safety features
  conflictCheck?: boolean;       // Pre-check for conflicts
  pushToRemote?: boolean;        // Backup to remote
  autoCommit?: boolean;          // Auto-commit on completion
  commitMessage?: string;        // Custom commit message
  
  // Cleanup
  cleanupStrategy?: 'preserve' | 'merge-and-delete' | 'archive';
}
```

### 2. Merge Strategies

#### Auto Merge
- Automatically merge to base branch if no conflicts
- Fail safely if conflicts detected
- Best for: Simple, isolated changes

#### Pull Request
- Push branch to remote
- Create PR via GitHub/GitLab API
- Best for: Production changes needing review

#### Manual
- Create branch but don't merge
- Developer reviews and merges manually
- Best for: Complex changes needing human review

#### Patch
- Generate patch file in `.claudine-patches/`
- Can be applied selectively later
- Best for: Experimental changes

### 3. Conflict Detection
```bash
# Before creating worktree, check if files will conflict
git diff --name-only HEAD..main | \
  xargs -I {} git diff HEAD main -- {} | \
  grep -c "^<<<<<<< "
```

### 4. Safe Commit Workflow
```typescript
async function safeCommitWorktree(worktreePath: string, taskId: string) {
  // 1. Check for changes
  const status = await execAsync('git status --porcelain', { cwd: worktreePath });
  if (!status.trim()) return; // No changes
  
  // 2. Stage changes
  await execAsync('git add -A', { cwd: worktreePath });
  
  // 3. Create descriptive commit
  const message = `Task ${taskId}: Automated changes\n\nGenerated by Claudine task delegation`;
  await execAsync(`git commit -m "${message}"`, { cwd: worktreePath });
  
  // 4. Create merge commit in main repo
  await execAsync(`git fetch ./worktree/${taskId} && git merge --no-ff FETCH_HEAD`);
}
```

### 5. CLI Usage Examples

```bash
# Safe experimentation with manual review
claudine delegate "refactor database layer" \
  --use-worktree \
  --create-branch \
  --merge-strategy manual

# Automated testing with auto-merge
claudine delegate "update dependencies" \
  --use-worktree \
  --create-branch \
  --auto-commit \
  --merge-strategy auto

# Production change with PR
claudine delegate "implement new feature" \
  --use-worktree \
  --create-branch \
  --push-to-remote \
  --merge-strategy pr \
  --branch-name "feature/new-capability"

# Generate patch for later
claudine delegate "experimental optimization" \
  --use-worktree \
  --merge-strategy patch
```

### 6. Recovery & Cleanup

```typescript
// List all task branches
git branch --list "claudine/task-*"

// Clean up old worktrees
git worktree prune
git branch -d claudine/task-abc123

// Archive worktree before deletion
tar -czf task-abc123.tar.gz .worktrees/task-abc123/
```

## Implementation Priority

1. **Phase 1**: Branch creation instead of detached HEAD
2. **Phase 2**: Auto-commit and patch generation
3. **Phase 3**: Conflict detection and safe merge
4. **Phase 4**: PR creation via GitHub API
5. **Phase 5**: Advanced strategies (rebase, squash, etc.)

## Safety Considerations

- Never force push
- Always preserve original branch state
- Generate patches as backup before any merge
- Require explicit flags for destructive operations
- Log all git operations for audit trail